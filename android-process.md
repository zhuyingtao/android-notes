## Android 进程

正常情况下，一个 apk 启动后只会运行在一个进程中，其进程名为 apk 的包名，所有的组件都会在这个进程中运行。

但是如果需要将某些组件运行在单独的进程中，就需要`android:process`属性了。我们可以给android的组件设置`android:process`属性来使其运行在指定的进程中。

- AndroidMantifest.xml中的activity、service、receiver和provider均支持`android:process`属性
- 设置该属性可以使每个组件均在各自的进程中运行，或者使一些组件共享一个进程
- AndroidMantifest.xml中的application元素也支持`android:process`属性，可以修改应用程序的默认进程名（默认值为包名）

#### 为何使用多进程

- 分散内存的占用

  Android系统对每个应用进程的内存占用是有限制的，而且占用内存越大的进程，通常被系统杀死的可能性越大。让一个组件运行在单独的进程中，可以减少主进程所占用的内存，避免OOM问题，降低被系统杀死的概率

- 实现多模块 

  当我们的应用开发越来越大，模块越来越多，团队规模也越来越大，协作开发也是个很麻烦的事情。项目解耦，模块化，是这阶段的目标。通过模块解耦，开辟新的进程，独立的JVM，来达到数据解耦目的。模块之间互不干预，团队并行开发，责任分工也明确。

- 子进程崩溃，主进程可以继续工作

  如果子进程因为某种原因崩溃了，不会直接导致主程序的崩溃，可以降低我们程序的崩溃率。

- 主进程退出，子进程可以继续工作

  即使主进程退出了，我们的子进程仍然可以继续工作，假设子进程是推送服务，在主进程退出的情况下，仍然能够保证用户可以收到推送消息。

#### 面临的问题

1. 如果`android:process`的值以冒号开头的话，那么该进程就是**私有进程**，以小写字母开头，那么就是公有进程。

2. 多进程 Application 的多次重建

   思路：判断是否为主进程，只有主进程的时候才执行下面的操作。

3. 静态成员的失效

4. 文件共享问题

#### 进程级别

进程的五个常用级别：

- **前台进程**（Foreground process）：前台进程就是用户当前要处理的所有事情都必须要使用的进程。满足下面的各种情况则认为是前台进程。

  - 进程持有一个正在和用户交互的 Activity。
  - 进程持有一个 Service，这个 Service 处于这几种状态：1. Service 与用户正在交互的 Activity 绑定。 2. Service 是在前台运行的。 3. Service 正在执行它的生命周期 onCreate() onStrarCommand，onDestroy。 4. 进程持有一个 BroadcastReceiver 这个 BroadcastReceiver 正在执行它的 onReceiver 方法。

  **杀死前台进程需要用户交互，前台进程的优先级最高**

- **可见进程**（Visible process）：如果一个进程不含任何前台的组件，但仍可被用户在屏幕上看到。当满足下面任意一条的时候，进程被认为是可见的。

  - 进程持有一个 activity，这个 activity 不在前台。但是仍然可见的情况。
  - 进程持有一个 Service ，这个 Service 与一个可见的 Activity 绑定。

  **可见的进程也被认为很重要，一般不会被销毁，除非是为了保证所有前台进程的运行而不得已不杀死可见进程的时候**

- **服务进程**（Service process）：如果一个进程中运行着一个 Service，这个 Service 是通过 startService() 开启的，并且不属于上面两种较高优先级的情况下，这个进程就是一个服务进程。尽管服务进程没有和用户可以看到的东西绑定，但是它们一般在做的事情是用户关心的，比如后台播放音乐，后台下载数据等。**所以系统会尽量维持它们的运行，除非系统内存不足以维持前台进程和可见进程的运行需要**（这句话和没说一样）

- **后台进程**（Background process）：如果进程不属于上面三种情况，但是进程持有一个用户不可见的 activity （activity 的 onStop 被调用，但是 onDestroy 没有被调用的状态）就认为进程是一个后台进程。

  **后台进程不直接影响用户体验，系统会为了前台进程、可见进程、服务进程而任意杀死后台进程**，通常情况下会有很多后台进程存在，他们会被保存在一个 LRU（least recently used）列表中，这样就可以确保用户最近使用的 Activity 最后被销毁，先销毁时间最远的 Activity。

- **空进程**：如果一个进程不包含任何活跃的应用组件，则认为是空进程。例如：一个进程当中已经没有数据运行了，但是内存当中还为这个应用保留了一个进程空间。保存这种进程的唯一理由是为了缓存的需要，为了加快下次启动这个进程中组件的启动时间，这种空进程经常被杀死。

